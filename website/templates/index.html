<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voting 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .ballot { animation: drop 2.2s infinite; }
        @keyframes drop {
            0%   { transform: translateY(-60px); opacity: 0; }
            40%  { opacity: 1; }
            60%  { transform: translateY(0px); }
            80%  { transform: translateY(5px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body class="bg-white text-gray-900">

    <!-- HEADER -->
    <header class="bg-black text-white shadow-lg p-4 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-green-400">Public Voting Portal 2025</h1>
            <p class="text-sm opacity-80">üìû +92-322-0790905 | ‚úâÔ∏è informationSecurity@seecs.edu.pk</p>
        </div>
        <div id="clock" class="text-lg font-mono text-green-400"></div>
    </header>

    <!-- MAIN WRAPPER: centers content vertically and horizontally -->
    <div class="flex flex-col items-center justify-center min-h-screen">

        <!-- PRE-VOTING -->
        <div id="preVoting" class="text-center">
            <h2 class="text-3xl font-bold text-black" id="preVotingText">Voting starts at 10:00 AM PST</h2>
            <p class="mt-4 text-gray-600">Please return once voting begins.</p>
        </div>

        <!-- LIVE VOTING -->
        <div id="liveVoting" class="hidden flex flex-col items-center">
            <div class="relative w-40 h-40 flex justify-center mb-4">
                <div class="ballot absolute w-16 h-20 bg-green-400 rounded shadow-lg"></div>
                <div class="absolute bottom-0 w-32 h-20 bg-gray-800 rounded-b-lg shadow-xl"></div>
                <div class="absolute bottom-16 w-28 h-4 bg-gray-900 rounded-sm"></div>
            </div>
            <h2 class="text-3xl font-bold text-black mb-4">Live Vote Count</h2>
            <p class="text-5xl font-extrabold text-green-600 drop-shadow-lg">
                <span id="vote-count">0</span>
            </p>
            <a href="{{ url_for('verify_vote') }}"
               class="mt-8 bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-bold shadow-lg transition">
               Verify My Vote
            </a>
        </div>

        <!-- POST-VOTING -->
        <div id="postVoting" class="text-center hidden">
            <h2 class="text-2xl font-bold">Voting has ended</h2>
            <p class="mt-4">Final results per candidate:</p>
            <ul id="final-results" class="mt-4 text-left inline-block text-lg"></ul>
        </div>

    </div>

    <script type="text/javascript">
        // Elements
        const preVotingEl = document.getElementById("preVoting");
        const liveVotingEl = document.getElementById("liveVoting");
        const postVotingEl = document.getElementById("postVoting");
        const preVotingTextEl = document.getElementById("preVotingText");
        const clockEl = document.getElementById("clock");

        // --- TIME LOGIC ---
        const startHour = parseInt("{{ start_hour }}", 10) || 0;
        const startMinute = parseInt("{{ start_minute }}", 10) || 0;
        const endHour = parseInt("{{ end_hour }}", 10) || 0;
        const endMinute = parseInt("{{ end_minute }}", 10) || 0;

        const votingStart = new Date();
        votingStart.setHours(startHour, startMinute, 0, 0);
        const votingEnd = new Date();
        votingEnd.setHours(endHour, endMinute, 0, 0);

        const candidateNames = ["Mian Ali Raza", "Ayesha Khan", "Farooq Siddiqui", "Sadaf Rehman"];
        
        let countdownInterval;
        let dataInterval;

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function updateVotingStatus() {
            const now = new Date();
            const votingStarted = now >= votingStart;
            const votingEnded = now >= votingEnd;

            clockEl.innerText = now.toLocaleTimeString('en-US', { hour: '2-digit', minute:'2-digit', second:'2-digit' });
            preVotingTextEl.innerText = `Voting starts at ${formatTime(votingStart)} PST`;

            if (votingEnded) {
                preVotingEl.style.display = 'none';
                liveVotingEl.style.display = 'none';
                postVotingEl.style.display = 'block';
                clearInterval(dataInterval);
                loadFinalResults();
                return;
            }

            if (votingStarted) {
                preVotingEl.style.display = 'none';
                liveVotingEl.style.display = 'flex';
                postVotingEl.style.display = 'none';
                loadVotes();
                return;
            }

            // Pre-voting
            preVotingEl.style.display = 'block';
            liveVotingEl.style.display = 'none';
            postVotingEl.style.display = 'none';
        }

        async function loadVotes() {
            try {
                const response = await fetch("/api/live_votes");
                if (!response.ok) return;
                const data = await response.json();
                document.getElementById("vote-count").textContent = data.total_votes_cast;
            } catch (err) { console.error("Error fetching live votes:", err); }
        }

        async function loadFinalResults() {
            try {
                const response = await fetch("/api/final_results");
                if (!response.ok) return;
                const data = await response.json();
                const resultsList = document.getElementById("final-results");
                resultsList.innerHTML = "";
                candidateNames.forEach((name, idx) => {
                    const li = document.createElement("li");
                    li.textContent = `${name}: ${data[idx]} votes`;
                    resultsList.appendChild(li);
                });
            } catch (err) { console.error("Error fetching final results:", err); }
        }

        function initDashboard() {
            updateVotingStatus();
            dataInterval = setInterval(updateVotingStatus, 5000);
        }

        window.onload = initDashboard;
    </script>

</body>
</html>
